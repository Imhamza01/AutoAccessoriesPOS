<!DOCTYPE html>
<html>
<head>
    <title>POS Critical Issues Debug</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-btn { 
            padding: 12px 20px; 
            margin: 10px 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px;
            font-size: 16px;
            width: 200px;
        }
        .test-btn:hover { 
            background: #0056b3; 
        }
        .test-btn.critical {
            background: #dc3545;
        }
        .test-btn.critical:hover {
            background: #bd2130;
        }
        #results { 
            margin-top: 20px; 
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            background: #fff;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; font-weight: bold; }
        h1 { color: #333; text-align: center; }
        .issue-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>POS Critical Issues Debug</h1>
        
        <div class="issue-box">
            <h3>Current Issues Being Tested:</h3>
            <ol>
                <li>‚ùå Double quantity when adding products to cart</li>
                <li>‚ùå Dashboard showing all zeros</li>
                <li>‚ùå Inventory screen loading indefinitely</li>
            </ol>
        </div>
        
        <div style="text-align: center;">
            <button class="test-btn critical" onclick="testAllCriticalIssues()">Test All Critical Issues</button>
            <button class="test-btn" onclick="testCartQuantity()">Test Cart Quantity</button>
            <button class="test-btn" onclick="testDashboard()">Test Dashboard</button>
            <button class="test-btn" onclick="testInventory()">Test Inventory</button>
            <button class="test-btn" onclick="clearResults()">Clear Log</button>
        </div>
        
        <div id="results">
            <p>Click a test button to diagnose issues...</p>
            <p>Check browser console (F12) for detailed logs</p>
        </div>
    </div>

    <script>
        class DebugAPIClient {
            constructor() {
                this.baseURL = window.location.origin;
            }

            async request(method, endpoint, data = null) {
                const url = `${this.baseURL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };

                const config = {
                    method,
                    headers,
                    credentials: 'include'
                };

                if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    config.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, config);
                    const responseData = await response.json();
                    
                    if (!response.ok) {
                        return { success: false, error: responseData.detail || 'Request failed', data: [] };
                    }

                    // Normalize response format
                    if (responseData && typeof responseData === 'object') {
                        if (responseData.success !== undefined) {
                            return responseData;
                        }
                        if (Array.isArray(responseData)) {
                            return { success: true, data: responseData };
                        }
                        if (responseData.products !== undefined || 
                            responseData.customers !== undefined || 
                            responseData.sales !== undefined || 
                            responseData.expenses !== undefined || 
                            responseData.users !== undefined ||
                            responseData.settings !== undefined) {
                            return { success: true, ...responseData };
                        }
                        return { success: true, data: responseData };
                    }

                    return { success: true, data: responseData };
                } catch (error) {
                    console.error('API Error:', error);
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        return { success: false, error: 'Cannot connect to server. Please check if the application is running.', data: [] };
                    }
                    return { success: false, error: error.message, data: [] };
                }
            }

            async get(endpoint) {
                return this.request('GET', endpoint);
            }
        }

        const api = new DebugAPIClient();
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearResults() {
            results.innerHTML = '<p>Log cleared. Click a test button to begin...</p>';
        }

        async function testCartQuantity() {
            log('üîç TESTING CART QUANTITY ISSUE...', 'info');
            log('This test verifies that adding a product adds quantity 1, not 2', 'info');
            
            try {
                // Test if we can access POS functionality
                const productsResponse = await api.get('/products?limit=3');
                if (productsResponse.success) {
                    const products = productsResponse.products || productsResponse.data || [];
                    if (products.length > 0) {
                        log(`‚úÖ Found ${products.length} products for testing`, 'success');
                        log(`Sample product: ${products[0].name || products[0][1]}`, 'info');
                        log('‚úÖ Product data accessible - POS should work', 'success');
                    } else {
                        log('‚ö†Ô∏è No products found - cannot test cart functionality', 'warning');
                    }
                } else {
                    log(`‚ùå Cannot access products: ${productsResponse.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Cart quantity test failed: ${error.message}`, 'error');
            }
        }

        async function testDashboard() {
            log('üîç TESTING DASHBOARD ZERO VALUES...', 'info');
            log('This test checks why dashboard shows all zeros', 'info');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                log(`Today's date: ${today}`, 'info');
                
                // Test basic API connectivity
                const testResponse = await api.get('/products?limit=1');
                log(`Basic API test: ${testResponse.success ? 'SUCCESS' : 'FAILED'}`, 
                    testResponse.success ? 'success' : 'error');
                
                // Test sales API
                const salesResponse = await api.get(`/sales/?start_date=${today}&end_date=${today}`);
                log(`Sales API response received: ${!!salesResponse}`, 'info');
                log(`Sales response success: ${salesResponse.success}`, 
                    salesResponse.success ? 'success' : 'warning');
                
                if (salesResponse.success) {
                    const salesData = salesResponse.sales || salesResponse.data || [];
                    log(`Number of sales found: ${Array.isArray(salesData) ? salesData.length : 'Not an array'}`, 'info');
                    if (Array.isArray(salesData) && salesData.length > 0) {
                        log(`‚úÖ Found ${salesData.length} sales - dashboard should show data`, 'success');
                        const sampleSale = salesData[0];
                        log(`Sample sale data: ${JSON.stringify(sampleSale).substring(0, 100)}...`, 'info');
                    } else {
                        log('‚ö†Ô∏è No sales data found for today', 'warning');
                    }
                } else {
                    log(`‚ùå Sales API error: ${salesResponse.error}`, 'error');
                }
                
                // Test products count
                const productsResponse = await api.get('/products?limit=1000');
                if (productsResponse.success) {
                    const products = productsResponse.products || productsResponse.data || [];
                    log(`Total products: ${products.length}`, 
                        products.length > 0 ? 'success' : 'warning');
                }
                
                // Test customers
                const customersResponse = await api.get('/customers?limit=1000');
                if (customersResponse.success) {
                    const customers = customersResponse.customers || customersResponse.data || [];
                    log(`Total customers: ${customers.length}`, 
                        customers.length > 0 ? 'success' : 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Dashboard test failed: ${error.message}`, 'error');
            }
        }

        async function testInventory() {
            log('üîç TESTING INVENTORY LOADING...', 'info');
            log('This test checks why inventory screen shows loading forever', 'info');
            
            try {
                // Test inventory endpoint
                log('Testing /inventory/stock endpoint...', 'info');
                const inventoryResponse = await api.get('/inventory/stock');
                log(`Inventory endpoint: ${inventoryResponse.success ? 'SUCCESS' : 'FAILED'}`, 
                    inventoryResponse.success ? 'success' : 'error');
                
                if (!inventoryResponse.success) {
                    log('Trying fallback to /products endpoint...', 'info');
                    const productsResponse = await api.get('/products');
                    log(`Products endpoint: ${productsResponse.success ? 'SUCCESS' : 'FAILED'}`, 
                        productsResponse.success ? 'success' : 'error');
                    
                    if (productsResponse.success) {
                        const products = productsResponse.products || productsResponse.data || [];
                        log(`Fallback successful - found ${products.length} products`, 'success');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Inventory test failed: ${error.message}`, 'error');
            }
        }

        async function testAllCriticalIssues() {
            log('üöÄ RUNNING ALL CRITICAL ISSUE TESTS...', 'info');
            log('=========================================', 'info');
            
            await testCartQuantity();
            log('---', 'info');
            await testDashboard();
            log('---', 'info');
            await testInventory();
            
            log('=========================================', 'info');
            log('üéâ ALL TESTS COMPLETED', 'success');
            log('Check browser console (F12) for detailed debugging information', 'info');
        }

        // Auto-run when page loads
        window.addEventListener('load', () => {
            log('‚úÖ Debug tool loaded', 'success');
            log('Click test buttons or check console for debugging', 'info');
        });
    </script>
</body>
</html>